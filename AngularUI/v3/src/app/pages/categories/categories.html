<div class="container">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h2>Categories Management</h2>
      <div *ngIf="notification()" class="alert alert-info">{{ notification() }}</div>

      <form *ngIf="form" [formGroup]="form!" (ngSubmit)="submit()" class="mb-4">

        <div class="row g-2">
          <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
            <input formControlName="uniqueId" type="hidden" />
            <input #nameInput formControlName="name" class="form-control" placeholder="Category Name" required />

            <div *ngIf="form.get('name')?.invalid && form.get('name')?.touched" class="text-danger">
              Category Name is required.
            </div>
          </div>
          <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
            <input formControlName="description" class="form-control" placeholder="Description" />
          </div>
          <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
            <input type="number" formControlName="allocatedAmount" class="form-control" placeholder="Allocated Amount"
              required />
            <div *ngIf="form.get('allocatedAmount')?.invalid && form.get('allocatedAmount')?.touched"
              class="text-danger">
              Allocated Amount is required and must be a positive number b/w 0 to 2,00,00,00,000.
            </div>

          </div>

          <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3" *ngIf="form.get('isSubCategory')?.value">
            <select formControlName="parentId" class="form-control">
              <option value="0" [selected]="true">-- Select Parent Category --</option>
              <option *ngFor="let category of getParentCategories" [value]="category.uniqueId">{{ category.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-12 d-flex justify-content-start align-items-center">
            <!-- Checkbox -->
            <input class="form-check-input me-2" type="checkbox" id="isSubCategory" formControlName="isSubCategory">
            <label class="form-check-label mb-0" for="isSubCategory">Add Sub Category</label>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary me-2" [disabled]="form.invalid">{{ isEditMode() ? 'Update' :
            'Create'
            }}</button>
          <button type="button" class="btn btn-secondary" (click)="clearForm()">Clear</button>
        </div>
      </form>



      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="mb-0  d-flex justify-content-left  ">Categories List</h4>
              <a href="#" class="btn btn-sm btn-outline-primary" data-page="transactions">View All</a>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table-sm table-hover mb-0" style="width: 100%;">
                  <thead class="table-light">
                    <tr>
                      <th>S.No.</th>
                      <th>Name</th>
                      <th>Description</th>
                      <th>Allocated Amount</th>
                      <th>Actions</th>
                    </tr>

                  </thead>
                  <tbody id="recent-transactions">


                    @for (cat of categories(); track cat.uniqueId) {
                    @if (cat.parentId === 0 || cat.parentId == null) {
                    <tr class="transaction-item expense">
                      <td>{{ cat.uniqueId }}</td>
                      <td>{{ cat.name }}</td>
                      <td>{{ cat.description }}</td>
                      <td class="text-danger">{{ cat.allocatedAmount | currency:'INR':'symbol':'1.0-0' }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" (click)="editCategory(cat)"><i
                            class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" (click)="deleteCategory(cat.uniqueId!)"><i
                            class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    }
                    @for (sub of cat.subCategories || []; track sub.uniqueId) {
                    <tr class="transaction-item income">
                      <td>{{ sub.uniqueId }}</td>
                      <td style="padding-left: 2em;">â†³ {{ sub.name }}</td>
                      <td>{{ sub.description }}</td>
                      <td class="text-success">{{ sub.allocatedAmount | currency:'INR':'symbol':'1.0-0' }}</td>
                      <td>
                        <div class="d-flex align-items-center gap-2">
                          <button class="btn btn-sm btn-outline-primary me-1" (click)="editCategory(sub)"><i
                              class="bi bi-pencil"></i></button>
                          <button class="btn btn-sm btn-outline-danger" (click)="deleteCategory(sub.uniqueId!)"><i
                              class="bi bi-trash"></i></button>
                        </div>
                      </td>
                    </tr>
                    }
                    @if ((cat.subCategories || []).length > 0) {
                    <tr class="table-success">
                      <td></td>
                      <td style="padding-left: 2em;"><strong>Total</strong></td>
                      <td></td>
                      <td><strong>{{ getTotalAllocatedAmount(cat.subCategories || []) |
                          currency:'INR':'symbol':'1.0-0'}}</strong></td>
                      <td colspan="2"></td>
                    </tr>
                    }
                    }

                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>
</div>